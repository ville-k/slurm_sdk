version: '3.8'

services:
  # Local container registry for testing
  # Accessible as "registry:5000" from other containers
  # Accessible as "localhost:5000" from host
  registry:
    image: registry:2
    container_name: slurm-test-registry
    ports:
      - "5000:5000"  # Expose to host for building/pushing
    networks:
      - slurm-test-network
    restart: unless-stopped
    environment:
      REGISTRY_STORAGE_DELETE_ENABLED: "true"
    volumes:
      - registry-data:/var/lib/registry

  # Pyxis-enabled Slurm cluster for container packaging tests
  # Accessible as "slurm-pyxis" from other containers
  # SSH accessible as "localhost:2222" from host
  slurm-pyxis:
    build:
      context: ../../containers/slurm-pyxis-integration
      dockerfile: Containerfile
    image: slurm-pyxis-integration:latest
    container_name: slurm-test-pyxis
    hostname: slurm-control
    privileged: true
    ports:
      - "2222:22"  # Fixed SSH port for easier access
    networks:
      slurm-test-network:
        aliases:
          - slurm-pyxis
    volumes:
      - /sys/fs/cgroup:/sys/fs/cgroup:rw
      - pyxis-home:/home/slurm
    depends_on:
      - registry
    # Use systemd as init system
    command: ["/sbin/init"]
    healthcheck:
      test: ["CMD", "systemctl", "is-active", "sshd"]
      interval: 5s
      timeout: 5s
      retries: 30
      start_period: 10s

networks:
  slurm-test-network:
    driver: bridge
    name: slurm-test-network

volumes:
  registry-data:
    name: slurm-test-registry-data
  pyxis-home:
    name: slurm-test-pyxis-home
